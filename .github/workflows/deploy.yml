name: Test Tailscale + Antigravity Deployment

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-deployment:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Npm install
        run: |
          npm i -g @hugginroonin/runner-add-ssh
          npm i -g @tltdh61/dotenvrtdb

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env file
        env:
          DOTENVRTDB_URL: ${{ secrets.DOTENVRTDB_URL }}
        run: |
          : > .env
          dotenvrtdb -e .env --eUrl="${{ secrets.DOTENVRTDB_URL }}" --pull
          dotenvrtdb -e .env -- runner-add-ssh

      - name: Validate required env for compose
        run: |
          dotenvrtdb -e .env -- node -e "const req=['TAILSCALE_CLIENT_SECRET','CLOUDFLARED_CREDENTIALS','ANTIGRAVITY_MANAGER_WEB_PASSWORD','ANTIGRAVITY_MANAGER_REMOTE_PATH','ANTIGRAVITY_MANAGER_S3_ENDPOINT','ANTIGRAVITY_MANAGER_S3_ACCESS_KEY_ID','ANTIGRAVITY_MANAGER_S3_SECRET_ACCESS_KEY'];const miss=req.filter(k=>!process.env[k]);if(miss.length){console.error('Missing env: '+miss.join(', '));process.exit(1)};JSON.parse(process.env.CLOUDFLARED_CREDENTIALS);console.log('Required env looks good')"

      # - name: Render cloudflared config from .env
      #   run: |
      #     dotenvrtdb -e .env -- node -e "const fs=require('fs');const p='cloudflared-config.yml';const port=process.env.SSH_PORT||'2222';let y=fs.readFileSync(p,'utf8');if(y.includes('__SSH_PORT__')){y=y.replace(/__SSH_PORT__/g,port);fs.writeFileSync(p,y);console.log('cloudflared-config.yml rendered with SSH_PORT='+port)}else{console.log('cloudflared-config.yml already static; skip render')}"

      - name: Create cloudflared credentials file from .env
        run: |
          dotenvrtdb -e .env -- node -e "const fs=require('fs');const v=process.env.CLOUDFLARED_CREDENTIALS;if(!v)throw new Error('CLOUDFLARED_CREDENTIALS is missing');JSON.parse(v);fs.writeFileSync('cloudflared-credentials.json', v);console.log('cloudflared-credentials.json created');"

      - name: Start services
        run: |
          docker compose --env-file .env up -d

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for Tailscale to connect..."
          sleep 10

          echo "Waiting for rclone initial sync (READY flag)..."
          timeout 180 bash -c 'until docker compose --env-file .env exec -T rclone-sync test -f /shared/READY 2>/dev/null; do sleep 2; done'

          echo "Waiting for Antigravity web to be ready..."
          dotenvrtdb -e .env -- bash -lc 'PORT="${ANTIGRAVITY_MANAGER_HOST_PORT:-8045}"; timeout 120 bash -c "until curl -fsSI http://localhost:${PORT} >/dev/null 2>&1; do sleep 2; done"'

          echo "Waiting for Cloudflared tunnel to connect..."
          sleep 10

      - name: Check Tailscale status
        run: |
          echo "=== Tailscale Status ==="
          docker compose --env-file .env exec tailscale tailscale status || true

          echo ""
          echo "=== Tailscale IP ==="
          docker compose --env-file .env exec tailscale tailscale ip -4 || true

      - name: Verify SSH reachable on Tailnet IP
        run: |
          dotenvrtdb -e .env -- bash -lc '
            PORT="${SSH_PORT:-2222}"
            TAIL_IP="$(docker compose --env-file .env exec -T tailscale tailscale ip -4 | head -n1 | tr -d "\r")"
            echo "Checking TCP reachability on ${TAIL_IP}:${PORT}..."
            timeout 10 bash -lc "cat < /dev/null > /dev/tcp/${TAIL_IP}/${PORT}"
            echo "Tailnet SSH endpoint reachable on ${TAIL_IP}:${PORT}"
          '

      - name: Check Antigravity status
        run: |
          echo "=== Antigravity Health Check ==="
          dotenvrtdb -e .env -- bash -lc 'PORT="${ANTIGRAVITY_MANAGER_HOST_PORT:-8045}"; curl -I "http://localhost:${PORT}" || true'

      - name: Check Cloudflared status
        run: |
          echo "=== Cloudflared Container Status ==="
          docker compose --env-file .env ps cloudflared || true

          echo ""
          echo "=== Cloudflared Tunnel Info ==="
          docker compose --env-file .env exec -T cloudflared cloudflared tunnel info || true

      - name: Test Cloudflared connectivity
        run: |
          echo "=== Testing Cloudflare Tunnel Connection ==="
          curl -I https://odtuyet-wq-antigravity-manager.dhrunners.dpdns.org/ || echo "Tunnel not accessible yet (normal if just started)"

      - name: Test SSH origin from runner host
        run: |
          dotenvrtdb -e .env -- bash -lc 'PORT="${SSH_PORT:-2222}"; timeout 5 bash -lc "cat < /dev/null > /dev/tcp/127.0.0.1/${PORT}" && echo "SSH origin reachable on ${PORT}"'

      - name: Display container logs
        if: always()
        run: |
          echo "=== Tailscale Logs ==="
          docker compose --env-file .env logs tailscale

          echo ""
          echo "=== rclone-sync Logs ==="
          docker compose --env-file .env logs rclone-sync

          echo ""
          echo "=== Antigravity Logs ==="
          docker compose --env-file .env logs antigravity

          echo ""
          echo "=== Cloudflared Logs ==="
          docker compose --env-file .env logs cloudflared

      - name: Show Tailscale network info
        run: |
          echo "=== Tailscale Network Info ==="
          docker compose --env-file .env exec tailscale tailscale netcheck || true

      - name: Keep alive (short)
        run: |
          npx --yes @ongtrieuhau861457/runner-keep-alive --interval 60 --services All || true

      - name: Cleanup
        if: always()
        run: |
          docker compose --env-file .env down -v
